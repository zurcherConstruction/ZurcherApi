const { SupplierInvoice, SupplierInvoiceItem, SupplierInvoiceWork, Expense, sequelize } = require('../src/data');
const { Op } = require('sequelize');

/**
 * SCRIPT DE ADAPTACI√ìN PARA PRODUCCI√ìN
 * 
 * Este script analiza los invoices existentes que usan el modelo antiguo
 * (con items y works) y los marca para revisi√≥n manual.
 * 
 * NO modifica datos autom√°ticamente para evitar p√©rdidas.
 */

async function analyzeProductionData() {
  try {
    await sequelize.authenticate();
    console.log('‚úÖ Conectado a la base de datos de PRODUCCI√ìN\n');
    console.log('‚ïê'.repeat(80));
    console.log('üìä AN√ÅLISIS DE DATOS EXISTENTES EN PRODUCCI√ìN');
    console.log('‚ïê'.repeat(80));
    console.log('');

    // 1. Estad√≠sticas generales de invoices
    const totalInvoices = await SupplierInvoice.count();
    const pendingInvoices = await SupplierInvoice.count({ where: { status: 'pending' } });
    const paidInvoices = await SupplierInvoice.count({ where: { status: 'paid' } });

    console.log('üìã SUPPLIER INVOICES:');
    console.log(`   Total: ${totalInvoices}`);
    console.log(`   ‚Ä¢ Pending: ${pendingInvoices}`);
    console.log(`   ‚Ä¢ Paid: ${paidInvoices}`);
    console.log('');

    // 2. Verificar invoices con items (modelo antiguo)
    const invoicesWithItems = await sequelize.query(`
      SELECT si."idSupplierInvoice", si."invoiceNumber", si.vendor, si."totalAmount", si.status,
             COUNT(sii."idSupplierInvoiceItem") as items_count
      FROM "SupplierInvoices" si
      INNER JOIN "SupplierInvoiceItems" sii ON sii."supplierInvoiceId" = si."idSupplierInvoice"
      GROUP BY si."idSupplierInvoice", si."invoiceNumber", si.vendor, si."totalAmount", si.status
      ORDER BY si."createdAt" DESC
    `, { type: sequelize.QueryTypes.SELECT });

    console.log('üîß INVOICES CON ITEMS (modelo antiguo):');
    if (invoicesWithItems.length === 0) {
      console.log('   ‚úÖ No hay invoices con items - sistema limpio');
    } else {
      console.log(`   ‚ö†Ô∏è  Encontrados ${invoicesWithItems.length} invoices con items:`);
      invoicesWithItems.slice(0, 10).forEach(inv => {
        console.log(`      ‚Ä¢ Invoice #${inv.invoiceNumber} - ${inv.vendor} - $${inv.totalAmount} (${inv.items_count} items)`);
      });
      if (invoicesWithItems.length > 10) {
        console.log(`      ... y ${invoicesWithItems.length - 10} m√°s`);
      }
    }
    console.log('');

    // 3. Verificar invoices con works (modelo antiguo)
    const invoicesWithWorks = await sequelize.query(`
      SELECT si."idSupplierInvoice", si."invoiceNumber", si.vendor, si."totalAmount", si.status,
             COUNT(siw."idSupplierInvoiceWork") as works_count
      FROM "SupplierInvoices" si
      INNER JOIN "SupplierInvoiceWorks" siw ON siw."supplierInvoiceId" = si."idSupplierInvoice"
      GROUP BY si."idSupplierInvoice", si."invoiceNumber", si.vendor, si."totalAmount", si.status
      ORDER BY si."createdAt" DESC
    `, { type: sequelize.QueryTypes.SELECT });

    console.log('üèóÔ∏è  INVOICES CON WORKS VINCULADOS (modelo antiguo):');
    if (invoicesWithWorks.length === 0) {
      console.log('   ‚úÖ No hay invoices con works vinculados - sistema limpio');
    } else {
      console.log(`   ‚ö†Ô∏è  Encontrados ${invoicesWithWorks.length} invoices con works:`);
      invoicesWithWorks.slice(0, 10).forEach(inv => {
        console.log(`      ‚Ä¢ Invoice #${inv.invoiceNumber} - ${inv.vendor} - $${inv.totalAmount} (${inv.works_count} works)`);
      });
      if (invoicesWithWorks.length > 10) {
        console.log(`      ... y ${invoicesWithWorks.length - 10} m√°s`);
      }
    }
    console.log('');

    // 4. Estad√≠sticas de expenses
    const totalExpenses = await Expense.count();
    const unpaidExpenses = await Expense.count({ where: { paymentStatus: 'unpaid' } });
    const paidExpenses = await Expense.count({ where: { paymentStatus: 'paid' } });
    const paidViaInvoice = await Expense.count({ where: { paymentStatus: 'paid_via_invoice' } });

    console.log('üí∞ EXPENSES:');
    console.log(`   Total: ${totalExpenses}`);
    console.log(`   ‚Ä¢ Unpaid: ${unpaidExpenses}`);
    console.log(`   ‚Ä¢ Paid: ${paidExpenses}`);
    console.log(`   ‚Ä¢ Paid via Invoice: ${paidViaInvoice}`);
    console.log('');

    // 5. Buscar expenses que parecen generados por invoices
    const autoGeneratedExpenses = await Expense.findAll({
      where: {
        [Op.or]: [
          { notes: { [Op.iLike]: '%supplier invoice%' } },
          { notes: { [Op.iLike]: '%invoice #%' } },
          { notes: { [Op.iLike]: '%generado autom√°ticamente%' } }
        ]
      },
      attributes: ['idExpense', 'typeExpense', 'amount', 'notes', 'paymentStatus'],
      limit: 10,
      order: [['createdAt', 'DESC']]
    });

    console.log('ü§ñ EXPENSES QUE PARECEN AUTO-GENERADOS:');
    if (autoGeneratedExpenses.length === 0) {
      console.log('   ‚úÖ No se encontraron expenses auto-generados');
    } else {
      console.log(`   ‚ö†Ô∏è  Encontrados ${autoGeneratedExpenses.length} expenses (mostrando primeros 10):`);
      autoGeneratedExpenses.forEach(exp => {
        console.log(`      ‚Ä¢ ${exp.typeExpense} - $${exp.amount} - ${exp.paymentStatus}`);
        console.log(`        Notes: ${exp.notes?.substring(0, 80)}...`);
      });
    }
    console.log('');

    // 6. Recomendaciones
    console.log('‚ïê'.repeat(80));
    console.log('üí° RECOMENDACIONES PARA DEPLOYMENT:');
    console.log('‚ïê'.repeat(80));
    console.log('');

    const hasOldModelData = invoicesWithItems.length > 0 || invoicesWithWorks.length > 0;

    if (!hasOldModelData) {
      console.log('‚úÖ SISTEMA LIMPIO - Deployment seguro');
      console.log('');
      console.log('   El sistema NO tiene datos del modelo antiguo.');
      console.log('   Puedes hacer el deployment sin migraciones adicionales.');
      console.log('');
      console.log('   Pasos sugeridos:');
      console.log('   1. Ejecutar migraci√≥n: create-supplier-invoice-expenses-prod.sql');
      console.log('   2. Hacer deployment del c√≥digo nuevo');
      console.log('   3. Probar creaci√≥n de invoices y vinculaci√≥n');
    } else {
      console.log('‚ö†Ô∏è  REQUIERE ATENCI√ìN - Datos del modelo antiguo detectados');
      console.log('');
      console.log(`   ‚Ä¢ ${invoicesWithItems.length} invoices con items`);
      console.log(`   ‚Ä¢ ${invoicesWithWorks.length} invoices con works`);
      console.log('');
      console.log('   Opciones:');
      console.log('');
      console.log('   OPCI√ìN 1 - MIGRACI√ìN MANUAL (RECOMENDADA):');
      console.log('   ‚Ä¢ Revisar cada invoice manualmente');
      console.log('   ‚Ä¢ Re-crear los invoices usando el nuevo sistema simplificado');
      console.log('   ‚Ä¢ Dejar los antiguos como referencia hist√≥rica');
      console.log('');
      console.log('   OPCI√ìN 2 - MANTENER AMBOS SISTEMAS:');
      console.log('   ‚Ä¢ Nuevo c√≥digo soporta ambos modelos');
      console.log('   ‚Ä¢ Invoices antiguos siguen funcionando');
      console.log('   ‚Ä¢ Nuevos invoices usan el modelo simplificado');
      console.log('');
      console.log('   OPCI√ìN 3 - MIGRACI√ìN AUTOM√ÅTICA:');
      console.log('   ‚Ä¢ Crear script para convertir autom√°ticamente');
      console.log('   ‚Ä¢ ‚ö†Ô∏è  RIESGOSO - puede perder informaci√≥n de items detallados');
      console.log('');
    }

    console.log('‚ïê'.repeat(80));
    console.log('');

    await sequelize.close();
    console.log('‚úÖ An√°lisis completado - Conexi√≥n cerrada');

  } catch (error) {
    console.error('‚ùå Error:', error.message);
    console.error(error);
    process.exit(1);
  }
}

// Ejecutar solo si se llama directamente
if (require.main === module) {
  analyzeProductionData();
}

module.exports = { analyzeProductionData };
